# api/utils/db.py
import sqlite3
from datetime import datetime

DB_PATH = "data/oportunidades.db"

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
    CREATE TABLE IF NOT EXISTS oportunidades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        portal TEXT,
        data_hora TEXT,
        anunciante TEXT,
        contato TEXT,
        modelo TEXT,
        ano INTEGER,
        km INTEGER,
        preco INTEGER,
        fipe INTEGER,
        diferenca INTEGER,
        local TEXT,
        link TEXT UNIQUE,
        status TEXT
    )
    """)
    conn.commit()
    conn.close()

def inserir_ou_atualizar(anuncio):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    # link é UNIQUE, evita duplicados
    try:
        c.execute("""
        INSERT INTO oportunidades
        (portal, data_hora, anunciante, contato, modelo, ano, km, preco, fipe, diferenca, local, link, status)
        VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)
        """, (
            anuncio['portal'],
            anuncio['data_hora'],
            anuncio.get('anunciante'),
            anuncio.get('contato'),
            anuncio.get('modelo'),
            anuncio.get('ano'),
            anuncio.get('km'),
            anuncio.get('preco'),
            anuncio.get('fipe'),
            anuncio.get('diferenca'),
            anuncio.get('local'),
            anuncio.get('link'),
            anuncio.get('status','novo')
        ))
        conn.commit()
    except sqlite3.IntegrityError:
        # anúncio já existe (mesmo link) — atualize se necessário
        c.execute("""
        UPDATE oportunidades SET
            preco=?, fipe=?, diferenca=?, status=?, data_hora=?
        WHERE link=?
        """, (
            anuncio.get('preco'),
            anuncio.get('fipe'),
            anuncio.get('diferenca'),
            anuncio.get('status','novo'),
            anuncio['data_hora'],
            anuncio['link']
        ))
        conn.commit()
    finally:
        conn.close()
